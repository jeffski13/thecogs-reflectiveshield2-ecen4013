<h1>CAN bus</h1>

<img src='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/Research/CAN/Research_CAN_headerimg.png' height='300px'> ACK: stack exchange inc<br>
<br>
<h2>Table of Contents</h2>

<br>
<br>
<hr />

<h2>Design Challenges</h2>

The following <a href='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/ReflectiveShield2.0_MarketingReqs.pdf'> marketing requirements</a> had a significant impact in the design of the CAN bus system:<br>
<br>
<ul>
<blockquote><li>MRS 2a: The shield must be able to communicate through MIRP packets and CANbus.</li>
<li>MRS 2d: The shield must transmit “I’m Dead” packet through CANbus to HIU if the shield has been hit too many times.</li>
<li>MRS 3c: Once the shield has been hit with a magical attack it should store the “energy” for a brief period allowing the user to release it on command.</li>
</ul></blockquote>

In accordance with MAGE, the Reflective Shield 2.0 will require CAN communication for communication with the HIU to update the server. See <a href='https://docs.google.com/spreadsheet/ccc?key=0AnikrnWukR9ldFlKZ0lTRVVxU1ZHR1kzUlZYd1pIX1E&usp=sharing'>MSIP/MCAN PAYLOAD Sheet</a> for more details.<br>
<br>
<h2>CAN bus Theory</h2>

Controller Area Network (CAN) communication is a serial protocol specified by Bosch commonly used in automobiles. It is used because it can perform very well in high noise situations due to the methods serial data are produced.<br>
<br>
<img src='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/Research/CAN/Research_CAN_hardwareDemo.png' />

The figure above shows a simplistic model of a CAN network. A CAN network can contain many nodes. Each of which can broadcast their own signals on the CANH and CANL lines. The signals are generated by creating a differential voltage across the CANH and CANL lines. In other words, each line sits at the same voltage in a ‘recessive’ state (logic 1). For a ‘dominant’ state, CANH is raised above the resting voltage and CANL is dropped below it, creating a voltage difference between the two lines. The node detects this and converts them into the data normally seen in a serial network.<br>
<br>
<br>
The diagram below shows how the CANH and CANL operate in order to produce a differential voltage and shows the logic level produced below the t-axis.<br>
<br>
<img src='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/Research/CAN/Research_CAN_hardwareDemo2.png' />

CAN bus is capable of working in high noise situations. This is because the CAN bus can be modeled as a transmission line and the two 120Ω resistors cancels out reflection from within the line. This makes CAN suitable for use in many applications such as automobiles and even the MAGE system.  CAN currently supports speeds up to 1 Mbps.<br>
<br>
<h2>The CAN Node</h2>

The node in a CAN network consists of three main parts:<br>
<br>
<ul>
<blockquote><li>Microcontroller</li>
<li>CAN Controller</li>
<li>CAN Transceiver</li>
</ul>
Figure 3 shows a block diagram of a CAN network with all three components.</blockquote>

The microcontroller is responsible for sending messages and determining what the messages mean. It must be able to decode and send messages according to a CAN data frame.<br>
The CAN Controller acts as a buffer for data and monitors the status of the CAN lines for errors and detects whether a message is currently being broadcast or not. In the case that a message is being sent on the broadcast it will wait until that message is done until it puts the message from the microcontroller on the line.<br>
The CAN transceiver modifies the serial (Tx) signals sent from the CAN controller into the levels seen on the CANH and CANL lines. It also reads the CAN lines and puts the data into serial (Rx) format to be read by the CAN controller. The transceiver also has protective circuitry to protect the CAN controller and microcontroller from overvoltage. It allows for 24V systems to be used on the CAN bus whereas microcontrollers normally operate at lower voltages (i.e 3.3V or 5V). 24V would likely ruin the chips.<br>
<br>
<h3>Synchronization and Baud</h3>

In order to ensure proper synchronization between nodes on the CAN bus, the bit timing is subdivided into 4 fields as shown below.<br>
<br>
<img src='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/Research/CAN/Research_CAN_bitTiming.png' />

The timing for each section (synchronization segment, propagation segment, phase segment 1, and phase segment 2) is given in TQ, timing quantum. There are a minimum of 8 TQ in a bit, but there can be up to 25. The number of TQ in a bit will determine the length of time a bit will take, and thereby the baud rate for the CAN bus.<br>
The baud rate pre-scalar can be calculated by the following equations:<br>
<br>
<br>
<img src='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/Research/CAN/Research_CAN_bitTimingEqu1.png' />   K= total # of TQ in a bit<br>
<img src='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/Research/CAN/Research_CAN_bitTimingEqu2.png' />   TCY = uC clock period length<br>
<br>
From these, the baud rate pre-scalar and bit timing registers can be set up to generate the desired baud rate on a CAN bus.<br>
<br>
<h3>The CAN Frame</h3>

The figure below shows a complete CAN frame and separates each field out according to its purpose.<br>
<br>
<img src='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/Research/CAN/Research_CAN_canFrame.png' />

The arbitration field contains a set of data called the identifier. The identifier determines the priority of the CAN transmission and also determines how the data will be interpreted. If two CAN signals were to be broadcast by two nodes simultaneously, then the signal with the highest priority will ‘win’ arbitration and the other signal will be delayed until the winner has been sent. The priority is determined by which signal has the most dominant (logic 0) bits until a recessive bit (logic 1) is sent. For example, the CAN frame above has an identifier (ID) of ‘0b0000010100’. If another frame was broadcast when this one was with an ID of ‘0b0000101000’ it would lose arbitration since it has a recessive bit that appears before the CAN frame above.<br>
<br>
The control field contains the data length bits (DL0-DL3). These bits let the CAN controllers know how long the following data field will be. The data field contains the information being sent on the CAN bus and is followed by a cyclic redundancy check. The CRC field is calculated by the CAN controller and is used for error checking in case of noise and misreads on the data. Each delimiter is used to verify that the bits are lining up correctly. If the delimiter isn’t read as recessive, then the CAN controller will throw an error frame.<br>
<br>
A remote frame consists of the same format as a data frame, but instead of sending data it requests it by sending the identifier for the data it needs and sending a dominant bit in the last bit of the arbitration field (request remote bit).<br>
<br>
<h3>CAN bus Transceiver</h3>

MCP2551 specs:<br>
<ul>
<blockquote><li>1 Mbps</li>
<li>ISO 11898</li>
</ul></blockquote>

Each CAN transceiver is capable of 1 Mbps and is built on the ISO 11898 standard. Since the HIU transceiver is the MCP2551, the two should easily communicate.<br>
<br>
<table>
<blockquote><tr>
<blockquote><td></td>
<td>VDD</td>
<td>Max Current</td>
<td>Speed</td>
<td>Version</td>
<td>Price</td>
</blockquote></tr>
<tr>
<blockquote><td>MCP2551</td>
<td>4.5V-5.5V</td>
<td>75 mA</td>
<td>≤ 1 Mbps</td>
<td>CAN 2.0B</td>
<td>Free ($1.18)</td>
</blockquote></tr></blockquote>


SPLIT – uses common mode stabilization (reference voltage output VDD/2) during normal mode<br>
VIO – digital I/O supply pin separate from VDD¬.<br>
<br>
For this project using a separate digital supply (VIO) isn’t possible with a single power supply on-board (this could just be tied to the same VDD). The MCP2551 was chosen over other models(some of which were SPLIT) because there is little difference between the MCP2551 that is already being used in the HIU.<br>
<br>
<h2>CAN bus Code</h2>

<h3>Function Headers</h3>
<i>CAN_Init();</i>
-Initializes CAN Module on PIC to match HIU baud, initializes DMA, and sets filters/masks<br>
<br>
<i>CAN_Send();</i>
-Puts data into DMA and requests transmission<br>
<br>
<i>CAN_Receive();</i>
-Called on interrupt, causes uC to read DMA registers for data and determines meaning.<br>
<br>
These functions can be called and left alone because of the use of DMA (direct memory access). This will allow the microcontroller to process other items (such as infrared) right away while DMA handles reception and transmission. If there are problems setting up DMA interrupts, then I can always drop DMA and not use it.<br>
<br>
<br>
<h3>Flow Charts</h3>

<img src='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/Research/CAN/Research_CAN_Flowchart_canInit.png' width='350px' />
<img src='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/Research/CAN/Research_CAN_Flowchart_canSend.png' height='350px' />
<img src='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/Research/CAN/Research_CAN_Flowchart_canReceive.png' height='350px' />

<h2>Schematic</h2>

<img src='https://thecogs-reflectiveshield2-ecen4013.googlecode.com/hg/wiki/Research/CAN/Research_CAN_DesignSch.png' />

Rext sets slew rate to ~24V/us<br>
U3 is for transient voltage suppression.<br>
For the PIC24, RXD and TXD pin locations can be selected through peripheral pin selection.<br>
C1 serves to stabilize Vdd and C2 stablizes RXD.<br>
<br>
<h2>Sources</h2>

stack exchange inc (2013)For the CAN bus, is it OK to swap CANH and CANL lines? <a href='Online.md'>Online</a> Available: <a href='http://electronics.stackexchange.com/questions/73303/for-the-can-bus-is-it-ok-to-swap-canh-and-canl-lines'>http://electronics.stackexchange.com/questions/73303/for-the-can-bus-is-it-ok-to-swap-canh-and-canl-lines</a>